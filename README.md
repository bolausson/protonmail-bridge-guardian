# ProtonMail Bridge Guardian

A monitoring and auto-recovery tool for ProtonMail Bridge Docker containers.

## Overview

ProtonMail Bridge Guardian monitors the health of your ProtonMail Bridge instance by performing periodic IMAP login checks. When connectivity issues are detected, it automatically restarts the bridge container to restore service, ensuring reliable email access.

## Features

- **Health Monitoring**: Performs periodic IMAP login checks to verify bridge connectivity
- **Automatic Recovery**: Restarts the bridge container when IMAP connectivity fails
- **Safety Limits**: Configurable maximum restarts per hour to prevent restart loops
- **Prometheus Metrics**: Exposes metrics for monitoring bridge status, failures, and restart counts
- **Configurable**: Fully customizable via environment variables

## Metrics

The guardian exposes Prometheus metrics on the configured port (default: 8008):

- `protonmail_bridge_status` - Current bridge status (1 = healthy, 0 = unhealthy)
- `protonmail_bridge_check_failures_total` - Total number of failed health checks
- `protonmail_bridge_restarts_total` - Total number of container restarts performed
- `protonmail_bridge_last_check_timestamp` - Timestamp of the last health check

## Configuration

All configuration is done via environment variables:

| Variable | Description | Default |
|----------|-------------|---------|
| `BRIDGE_NAME` | Name of the ProtonMail Bridge container to monitor | `protonmail-bridge` |
| `IMAP_HOST` | IMAP hostname (usually the bridge container name) | `protonmail-bridge` |
| `IMAP_PORT` | IMAP port | `143` |
| `IMAP_USER` | ProtonMail Bridge username | (required) |
| `IMAP_PASS` | ProtonMail Bridge password | (required) |
| `CHECK_INTERVAL` | Seconds between health checks | `20` |
| `RESTART_COOLDOWN` | Seconds to wait after restarting before next check | `30` |
| `MAX_RESTARTS_PER_HOUR` | Maximum restarts allowed per hour | `5` |
| `STARTUP_DELAY` | Seconds to wait before starting monitoring | `30` |
| `METRICS_PORT` | Port to expose Prometheus metrics | `8008` |

## Docker Compose Integration
Example how it can be integrated into a docker-compose.yml
```yaml
networks:
  my-network:

services:
# [...]
  protonmail-bridge:
    container_name: protonmail-bridge
    image: shenxn/protonmail-bridge:build
    ports:
      - 1025:25/tcp
      - 1143:143/tcp
    restart: unless-stopped
    volumes:
      - protonmail:/root
    networks:
      - my-network

  protonmail-guardian:
    build: /opt/protonmail-bridge-guardian
    container_name: protonmail-guardian
    depends_on:
      - protonmail-bridge
    environment:
      BRIDGE_NAME: protonmail-bridge
      IMAP_HOST: protonmail-bridge
      IMAP_PORT: "143"
      IMAP_USER: "<proton-mail-bridge-user>"
      IMAP_PASS: "<proton-mail-bridge-autogenerated-password>"
      CHECK_INTERVAL: "20"
      RESTART_COOLDOWN: "30"
      MAX_RESTARTS_PER_HOUR: "5"
      STARTUP_DELAY: "30"
      METRICS_PORT: "8008"
    ports:
      - "8008:8008"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - my-network
    restart: always

volumes:
# [...]
  protonmail:
    name: protonmail
```

## Monitoring with VictoriaMetrics/Prometheus

VictoriaMetrics VMAgent scrape config:

```yaml
  - job_name: 'protonmail-guardian'
    static_configs:
      - targets: ["10.0.0.111:8008@<some-name>"]
    relabel_configs:
      - source_labels: [ __address__ ]
        regex: '(.*)@(.*)'
        replacement: $2
        target_label: instance
      - source_labels: [ __address__ ]
        regex: '(.*)@(.*)'
        replacement: $1
        target_label: __address__
```

## Grafana Dashboard

A pre-built Grafana dashboard is included in `Grafana-Dashboard.json` for visualizing:
- Bridge health status
- Check failure trends
- Restart history
- System metrics

Import the dashboard into your Grafana instance to get started with monitoring.

## Requirements

- Docker with access to `/var/run/docker.sock`
- ProtonMail Bridge container running
- ProtonMail Bridge credentials (username and auto-generated password)
